import requests, sys, json, bs4

ROOT_URL = "https://www.exploit-db.com/search"
VERIFIED_EXPLOITS_URL = ROOT_URL+"?verified=true&q="
NON_VERIFIED_EXPLOITS_URL = ROOT_URL+"?verified=false&q="

def parse_exploits_to_list(response):
    l = []
    data = []
    try:
        data = json.loads(response)["data"]
    except Exception:
        print("ERR: cant parse.. there is not data in dictionary, its either network error or they changed site")
        return None

    for e in data:
        href_html = e["download"]
        href = bs4.BeautifulSoup(href_html, features="lxml").find_all("a")[0]["href"]
        l.append(
                {
                    "title": str(e["description"][1]).replace("&#039;","'"),
                    "link": ROOT_URL + href,
                    "type": e["type_id"],
                    "platform": e["platform_id"]
                    }
                )
    return l

def search(search):
    '''returns dictionary with list of verified and/or nonverified(nverified) exploits or None'''
    if len(search) < 3:
        if input("Are you sure your search phrase is less than 3 letters? [y/n]") not in ["Y","y"]:
            print("Ok, terminating search..")
            sys.exit(1)
    
    headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Language": "en-US,en;q=0.5",
            "Accept-Encoding": "gzip, deflate, br",
            "DNT": "1",
            "Connection": "keep-alive",
            "X-Requested-With": "XMLHttpRequest"}

    verified_r = requests.get(VERIFIED_EXPLOITS_URL+search, headers=headers)
    nverified_r = requests.get(NON_VERIFIED_EXPLOITS_URL+search, headers=headers)
    verified = parse_exploits_to_list(verified_r.text)
    nverified = parse_exploits_to_list(nverified_r.text)

    return {"verified": verified, "nverified": nverified}

def print_exploits(exploits):
    print("="*40)
    for e in exploits:
        print(e["title"])
        print("link: " + e["link"])
        print("type: " + e["type"])
        print("platform: " + e["platform"])
        print("="*40)
            

if __name__ == '__main__':
    print("="*10)
    res = search(input("Enter search keyword:\n> "))
    print("="*10)
    if res is None:
        print("Cant find any exploits for %s" % (res, ))
    else:
        if res["verified"]:
            print("FOUND VERIFIED EXPLOITS!")
            print_exploits(res["verified"])
        else:
            print("Didn't find any verified exploits..")

        if res["nverified"]:
            print("FOUND NON VERIFIED EXPLOITS!")
            print_exploits(res["nverified"])
        else:
            print("Didn't find any non verified exploits..")

